<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>SDP example</title>
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="container">
    <h1>SDP example via WebRTC</h1>
    <a href="/" class="link-back">back to list </a>
    <div id="description">
        <p>
            On start, ice&#8209;client (your browser) fetches ice&#8209;configuration from server <a href="http://github.com/cydev/web">cydev/web</a>
            (which handles both STUN with <a href="http://github.com/ernado/stun">ernado/stun</a> and HTTP),
            creates new RTCPeerConnection and gathers ice&#8209;candidates via binding requests from server.
            Server saves received packet as <code>stun.Message</code> before responding with binding response.
            Then ice&#8209;client creates ice&#8209;offer and sends it to web server.
            Ser responds with HTML that is appended to this page,
            parsing ice&#8209;offer as <code>stun.Session</code> and every ice&#8209;candidate <code>ice.Candidate</code> with
            <a href="http://github.com/ernado/ice">ernado/ice</a>. For server&#8209;reflexive candidates server dumps
            saved <code>stun.Message</code>.
        </p>
        <p>Use <code>go install github.com/ernado/stun/stun-decode</code> to decode raw STUN messages.</p>
        <p>
            <code>// TODO(ar): visualise client-server interaction</code>
        </p>
    </div>
</div>
<div id="response">Waiting for server response.</div>
</body>
<script src="https://webrtc.github.io/adapter/adapter-latest.js" type="text/javascript"></script>
<script type="text/javascript">
    // TODO(ar): fetch iceServers from server
    fetch("/ice-configuration", { method: "POST"} ).then(function(res) {
        return res.json();
    }).then(function(configuration) {
        var pc = new RTCPeerConnection(configuration);
        var dc = pc.createDataChannel('webrtchacks');
        pc.onicecandidate = function (event) {
            if (!event.candidate) fetch("/sdp",
                {
                    method: "POST",
                    body: pc.localDescription.sdp
                })
                .then(function (res) {
                    return res.text();
                })
                .then(function (data) {
                    document.getElementById("response").innerHTML = data;
                })
        };
        pc.createOffer(
            function (offer) {
                pc.setLocalDescription(offer);
                // console.log(offer.sdp);
            },
            function (err) {
                console.error(err);
            }
        )
    });
</script>
</html>
